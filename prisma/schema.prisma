generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Checkout {
  id           String         @id @default(cuid())
  shop         String
  checkoutId   String
  token        String?
  email        String?
  phone        String?
  value        Float
  currency     String
  status       CheckoutStatus @default(OPEN)
  abandonedAt  DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  raw          String?
  customerName String?
  itemsJson    String?

  recoveredAt      DateTime?
  recoveredOrderId String?
  recoveredAmount  Float?

  @@unique([shop, checkoutId], name: "shop_checkoutId")
  @@index([shop, status, createdAt])
}

model Order {
  id            String   @id @default(cuid())
  shop          String
  orderId       String
  checkoutId    String?
  checkoutToken String?
  total         Float?
  currency      String?
  financial     String?
  createdAt     DateTime @default(now())
  raw           String?

  @@unique([shop, orderId], name: "shop_orderId")
  @@index([shop, createdAt])
}

model CallJob {
  id             String        @id @default(cuid())
  shop           String
  checkoutId     String
  phone          String
  scheduledFor   DateTime
  status         CallJobStatus @default(QUEUED)
  attempts       Int           @default(0)
  provider       String?
  providerCallId String?
  outcome        String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  endedReason    String?
  transcript     String?
  recordingUrl   String?
  sentiment      String?
  tagsCsv        String?
  reason         String?
  nextAction     String?
  followUp       String?
  analysisJson   String?

  attributedAt      DateTime?
  attributedOrderId String?
  attributedAmount  Float?

  @@index([shop, status, scheduledFor])
  @@index([shop, checkoutId])
}

model Settings {
  id              String  @id @default(cuid())
  shop            String  @unique

  enabled         Boolean @default(false)
  delayMinutes    Int     @default(30)
  maxAttempts     Int     @default(3)
  retryMinutes    Int     @default(30)
  minOrderValue   Float   @default(0)
  currency        String  @default("USD")
  callWindowStart String  @default("09:00")
  callWindowEnd   String  @default("19:00")

  vapiAssistantId   String?
  vapiPhoneNumberId String?

  userPrompt     String     @default("")
  promptMode     PromptMode @default(append)
  merchantPrompt String     @default("")

  tone                   String  @default("neutral")
  goal                   String  @default("complete_checkout")
  max_call_seconds       Int     @default(120)
  max_followup_questions Int     @default(2)

  discount_enabled            Boolean @default(false)
  max_discount_percent        Int     @default(10)
  offer_rule                  String  @default("ask_only")
  min_cart_value_for_discount Float?
  coupon_prefix               String?
  coupon_validity_hours       Int     @default(24)
  free_shipping_enabled       Boolean @default(false)

  followup_email_enabled Boolean @default(true)
  followup_sms_enabled   Boolean @default(true)

  // SMS templates (new)
  sms_template_offer    String?
  sms_template_no_offer String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([shop])
}

model Session {
  id                  String   @id
  shop                String
  state               String
  isOnline            Boolean  @default(false)
  scope               String?
  expires             DateTime?
  accessToken         String
  userId              BigInt?
  firstName           String?
  lastName            String?
  email               String?
  accountOwner        Boolean  @default(false)
  locale              String?
  collaborator        Boolean? @default(false)
  emailVerified       Boolean? @default(false)
  refreshToken        String?
  refreshTokenExpires DateTime?

  @@index([shop])
}

enum PromptMode {
  append
  replace
  default_only
}

enum CheckoutStatus {
  OPEN
  ABANDONED
  CONVERTED
  RECOVERED
}

enum CallJobStatus {
  QUEUED
  CALLING
  COMPLETED
  FAILED
  CANCELED
}